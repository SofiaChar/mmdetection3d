- step:
    name: train
    image: valohai/mmdetection3d
    environment: aws-eu-west-1-io2-g4dn-4xlarge
    command:
    - set -x
    - apt-get update
    - apt-get install -y unzip wget zip
    - pip install valohai-utils watchdog
    - mkdir /valohai/repository/checkpoints/
    - cp /valohai/inputs/model_weights/* /valohai/repository/checkpoints/
    - mkdir -p /valohai/repository/data/
    - unzip -qq /valohai/inputs/kitti_dataset/kitti_processed.zip -d /valohai/repository/data/
    - nohup python ./valohai_utils/log_handler.py &
    - python tools/train.py {parameters}
    inputs:
    - name: model_weights
      default: https://download.openmmlab.com/mmdetection3d/pretrain_models/mvx_faster_rcnn_detectron2-caffe_20e_coco-pretrain_gt-sample_kitti-3-class_moderate-79.3_20200207-a4a6a3c7.pth
    - name: kitti_dataset
      default: dataset://kitti_processed/v1
    parameters:
      - name: config
        default: /valohai/repository/configs/mvxnet/mvxnet_fpn_dv_second_secfpn_8xb2-80e_kitti-3d-3class.py
        optional: false
        type: string
        pass-as: "{v}"
      - name: work-dir
        default: /valohai/outputs/
        optional: true
        type: string
      - name: amp
        default: false
        type: flag
      - name: resume
        default: auto
        optional: true
        type: string
      - name: launcher
        default: none
        optional: true
        type: string
        choices:
          - none
          - pytorch
          - slurm
          - mpi

- step:
    name: demo
    image: sofiiavalohai/mmdetection3d:v1
    environment: aws-eu-west-1-g4dn-xlarge
    command:
      - pip install mmdet3d
      - python demo/pcd_demo.py {parameters}
    parameters:
      - name: pcd
        default: demo/data/kitti/kitti_000008.bin
        optional: false
        type: string
      - name: model
        default: configs/second/hv_second_secfpn_6x8_80e_kitti-3d-car.py
        optional: false
        type: string
      - name: weights
        default: /valohai/inputs/checkpoint/hv_second_secfpn_6x8_80e_kitti-3d-car_20200620_230238-393f000c.pth
        optional: false
        type: string
      - name: device
        default: cuda:0
        optional: true
        type: string
      - name: pred_score_thr
        default: 0.3
        optional: true
        type: float
      - name: out_dir
        default: outputs
        optional: true
        type: string
      - name: show
        default: false
        pass-false-as: --show=false
        pass-true-as: --show=true
        type: flag
      - name: wait_time
        default: -1
        optional: true
        type: float
      - name: no_save_vis
        default: false
        pass-false-as: --no-save-vis=false
        pass-true-as: --no-save-vis=true
        type: flag
      - name: no_save_pred
        default: false
        pass-false-as: --no-save-pred=false
        pass-true-as: --no-save-pred=true
        type: flag
      - name: print_result
        default: false
        pass-false-as: --print-result=false
        pass-true-as: --print-result=true
        type: flag
    inputs:
      - name: checkpoint
        default: s3://dd-sample-bucket/mmdetection3d/hv_second_secfpn_6x8_80e_kitti-3d-car_20200620_230238-393f000c.pth


- step:
    name: prep_scannet_dataset
    image: valohai/mmdetection3d
    environment: aws-eu-west-1-g4dn-xlarge
    command:
    - python ./data/scannet/batch_load_scannet_data.py
    - python ./tools/create_data.py {parameters:dataset} {parameters:root-path}
      {parameters:out-dir}
    - zip -r /valohai/outputs/scannet_data.zip /valohai/outputs/data/scannet
    - python save_metadata.py {parameters:file_path} {parameters:dataset_name} {parameters:dataset_version}
    parameters:
      - name: dataset
        default: scannet
        type: string
      - name: root-path
        default: ./data/scannet
        type: string
      - name: out-dir
        default: /valohai/outputs/data/scannet
        type: string
      - name: file_path
        default: /valohai/outputs/scannet_data.zip
        type: string
      - name: dataset_name
        default: scannet_det
        type: string
      - name: dataset_version
        default: base_v1
        type: string
